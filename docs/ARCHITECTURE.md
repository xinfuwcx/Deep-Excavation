# 系统架构 V2 (Q3 2025)

本文档描述了重构后的深基坑分析系统（V2）的架构设计。新架构旨在实现更清晰、更轻量、更易于扩展的系统，聚焦于核心的"建模-计算-AI"工作流。

## 1. 核心理念与目标

- **模块化**: 将系统解耦为独立的前端、后端和计算服务。
- **服务化**: 通过定义清晰的API进行通信，而非紧密耦合的内部调用。
- **聚焦核心**: 剥离遗留的、复杂的、非核心的功能，专注于`几何 -> 网格 -> 计算 -> AI`的核心链路。
- **现代化技术栈**: 采用现代Web和计算技术，提升开发效率和系统性能。

## 2. 系统架构

新系统主要由三大块组成：**前端应用**、**后端API网关**和**核心计算服务**。

```mermaid
graph TD
    subgraph 用户端
        A[浏览器 - React前端应用]
    end

    subgraph 服务端 (Docker容器化)
        B[后端API网关 <br/> FastAPI]
    end
    
    subgraph 核心计算服务
        C[几何服务 <br/> Chili3D/Python Wrapper]
        D[网格服务 <br/> Netgen]
        E[有限元计算 <br/> Kratos]
        F[物理AI服务 <br/> Python/PyTorch]
    end

    A -- REST API <br/> (HTTP/JSON) --> B
    B -- RPC/API --> C
    B -- RPC/API --> D
    B -- RPC/API --> E
    B -- RPC/API --> F
```

### 2.1 前端应用 (Frontend Application)

- **职责**: 提供完整的用户交互界面，包括参数输入、流程控制、状态显示和结果可视化。
- **技术栈**:
  - **框架**: React
  - **UI组件库**: Material-UI (MUI)
  - **状态管理**: Zustand
  - **API客户端**: Axios

### 2.2 后端API网关 (Backend API Gateway)

- **职责**: 作为前端和后端核心服务之间的唯一入口和协调者。它负责：
  - 接收前端的HTTP请求。
  - 验证用户输入。
  - 调用一个或多个核心计算服务来完成任务。
  - 管理长时任务（如计算、训练）的状态和轮询。
  - 将结果返回给前端。
- **技术栈**:
  - **Web框架**: FastAPI (Python)
  - **数据验证**: Pydantic

### 2.3 核心计算服务 (Core Services)

这些是独立的、可按需调用的服务，负责执行具体的计算任务。在当前架构中，它们通过后端的Python Wrapper被调用。

- **几何服务 (Geometry)**: 基于Chili3D库，负责创建和参数化几何模型。
- **网格服务 (Meshing)**: 基于Netgen，负责将几何模型剖分为高质量的有限元网格。
- **有限元计算 (FEM)**: 基于Kratos，负责执行结构和渗流的有限元分析。
- **物理AI服务 (Physics AI)**: 负责执行参数反演、代理模型训练等AI相关任务。

## 3. 核心工作流

以一次完整的"物理AI参数反演"为例，数据流如下：

1.  **用户**在前端界面中选择项目和反演参数，点击"开始"。
2.  **前端应用**将请求发送到**后端API网关**的 `/api/ai/parameter-inversion/start` 端点。
3.  **API网关**创建一个任务ID，并异步触发**物理AI服务**。
4.  **物理AI服务**在后台运行，它可能会调用**几何**、**网格**和**有限元**服务来反复进行正向计算，以匹配监测数据。
5.  **前端应用**使用任务ID，定期轮询API网关的 `/api/jobs/{id}/status` 端点，获取进度。
6.  **API网关**返回任务的实时状态(`running`, `progress: 50%`)。
7.  任务完成后，**API网关**在状态接口中返回 `completed` 和最终的反演结果。
8.  **前端应用**将结果展示给用户。

## 4. 技术栈总结

| 领域     | 主要技术                               |
| :------- | :------------------------------------- |
| **前端** | React, TypeScript, MUI, Zustand, Vite, **Three.js** |
| **后端** | FastAPI, Pydantic (Python)             |
| **计算** | Kratos, Netgen, Chili3D, PyTorch       |
| **部署** | Docker                                 |

这个精简的架构为未来扩展提供了坚实的基础。例如，我们可以轻松地添加新的AI功能，或者将某个核心计算服务替换为更高效的实现，而无需对整个系统进行大规模改造。 